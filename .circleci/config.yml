version: 2
jobs:
  update_repository:
    docker:
      - image: debian:stretch-slim
    working_directory: ~/repo
    branches:
      only:
        - master
    steps:
      - run:
          name: Install dependencies
          command: |
            apt-get update
            apt-get install -y build-essential
            apt-get install -y git
      - run:
          name: Configure Git user
          command: |  
            git config credential.helper 'cache --timeout=120'
            git config user.name "CircleCI"
            git config user.email "circleci"
      - run:
          name: Checkout source
          command: |
            git clone https://${GITHUB_PERSONAL_TOKEN}@github.com/morgrimm/repo.git .
            git submodule sync
            git submodule update --init
            git checkout ${CIRCLE_BRANCH}
      - run:
          name: Clean
          command: make clean
      - run:
          name: Build packages
          command: make debs
      - run:
          name: Generate depictions
          command: make depictions
      - run:
          name: Generate release
          command: make Release
      - run:
          name: Push release
          command: |
            git add -A
            git commit -m "RELEASE by CircleCI [skip ci]"
            git push -q https://${GITHUB_PERSONAL_TOKEN}@github.com/morgrimm/repo.git ${CIRCLE_BRANCH}
  update_host:
    docker:
      - image: debian:stretch-slim
    working_directory: ~/morgrimm.github.io
    branches:
      only:
        - master
    steps:
      - run:
          name: Install dependencies
          command: |
            apt-get update
            apt-get install -y git
      - run:
          name: Configure Git user
          command: |  
            git config credential.helper 'cache --timeout=120'
            git config user.name "CircleCI"
            git config user.email "circleci"
      - run:
          name: Checkout source
          command: |
            git clone https://${GITHUB_PERSONAL_TOKEN}@github.com/morgrimm/morgrimm.github.io.git .
            git checkout ${CIRCLE_BRANCH}
      - run: git submodules update --remote --merge
      - run:
          name: Update repo submodule
          command: |
            git add -A
            git commit -m "Update repo submodule by CircleCI [skip ci]"
            git push -q https://${GITHUB_PERSONAL_TOKEN}@github.com/morgrimm/morgrimm.github.io.git ${CIRCLE_BRANCH}
